package github

import (
	"fmt"
	"regexp"
	"strings"
	"testing"

	"github.com/hashicorp/terraform-plugin-testing/helper/acctest"
	"github.com/hashicorp/terraform-plugin-testing/helper/resource"
	"github.com/shurcooL/githubv4"
)

func TestAccGithubTeamSettings(t *testing.T) {
	t.Run("manages team settings can use team_id id and slug", func(t *testing.T) {
		randomID := acctest.RandStringFromCharSet(5, acctest.CharSetAlphaNum)
		teamName := fmt.Sprintf("%steam-settings-%s", testResourcePrefix, randomID)
		config := fmt.Sprintf(`
			resource "github_team" "test" {
				name        = "%s"
				description = "generated by terraform provider automated testing"
			}

			resource "github_team_settings" "test" {
				team_id    = "${github_team.test.id}"
			}
		`, teamName)

		resource.Test(t, resource.TestCase{
			PreCheck:          func() { skipUnlessHasOrgs(t) },
			ProviderFactories: providerFactories,
			Steps: []resource.TestStep{
				{
					Config: config,
					Check: resource.ComposeTestCheckFunc(
						resource.TestCheckResourceAttrSet("github_team_settings.test", "team_id"),
					),
				},
				{
					Config: strings.Replace(config,
						`github_team.test.id`,
						`github_team.test.slug`, 1),
					Check: resource.ComposeTestCheckFunc(
						resource.TestCheckResourceAttrSet("github_team_settings.test", "team_id"),
					),
				},
			},
		})
	})

	t.Run("manages team code review settings", func(t *testing.T) {
		randomID := acctest.RandStringFromCharSet(5, acctest.CharSetAlphaNum)
		teamName := fmt.Sprintf("%steam-settings-%s", testResourcePrefix, randomID)
		testAlgorithm := githubv4.TeamReviewAssignmentAlgorithmRoundRobin
		config := `
			resource "github_team" "test" {
				name        = "%s"
				description = "generated by terraform provider automated testing"
			}

			resource "github_team_settings" "test" {
				team_id    = "${github_team.test.id}"
				review_request_delegation {
					algorithm = "%s"
					member_count = %d
					notify = %t
				}
			}
		`

		resource.Test(t, resource.TestCase{
			PreCheck:          func() { skipUnlessHasOrgs(t) },
			ProviderFactories: providerFactories,
			Steps: []resource.TestStep{
				{
					Config: fmt.Sprintf(config, teamName, testAlgorithm, 1, true),
					Check: resource.ComposeTestCheckFunc(
						resource.TestCheckResourceAttr("github_team_settings.test", "review_request_delegation.0.algorithm", string(testAlgorithm)),
					),
				},
				{
					Config: fmt.Sprintf(config, teamName, githubv4.TeamReviewAssignmentAlgorithmLoadBalance, 1, true),
					Check: resource.ComposeTestCheckFunc(
						resource.TestCheckResourceAttr("github_team_settings.test", "review_request_delegation.0.algorithm", string(githubv4.TeamReviewAssignmentAlgorithmLoadBalance)),
					),
				},
				{
					Config: fmt.Sprintf(config, teamName, testAlgorithm, 3, true),
					Check: resource.ComposeTestCheckFunc(
						resource.TestCheckResourceAttr("github_team_settings.test", "review_request_delegation.0.member_count", "3"),
					),
				},
				{
					Config: fmt.Sprintf(config, teamName, testAlgorithm, 3, false),
					Check: resource.ComposeTestCheckFunc(
						resource.TestCheckResourceAttr("github_team_settings.test", "review_request_delegation.0.notify", "false"),
					),
				},
			},
		})
	})

	t.Run("cannot manage team code review settings if disabled", func(t *testing.T) {
		randomID := acctest.RandStringFromCharSet(5, acctest.CharSetAlphaNum)
		teamName := fmt.Sprintf("%steam-settings-%s", testResourcePrefix, randomID)
		config := fmt.Sprintf(`
			resource "github_team" "test" {
				name        = "%s"
				description = "generated by terraform provider automated testing"
			}

			resource "github_team_settings" "test" {
				team_id    = "${github_team.test.id}"
				review_request_delegation {
					algorithm = "invalid"
					member_count = 1
					notify = true
				}
			}
		`, teamName)

		resource.Test(t, resource.TestCase{
			PreCheck:          func() { skipUnlessHasOrgs(t) },
			ProviderFactories: providerFactories,
			Steps: []resource.TestStep{
				{
					Config:      config,
					ExpectError: regexp.MustCompile(`expected algorithm to be one of \[.*\]`),
				},
			},
		})
	})
}
